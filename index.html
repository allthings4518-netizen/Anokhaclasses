<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anokha Classes - Unified Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: flex; flex-direction: column; min-height: 100vh; }
        .page main { flex-grow: 1; overflow-y: auto; }
        .table-cell { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .chat-bubble { max-width: 80%; }
        .chat-bubble.user { background-color: #dbeafe; align-self: flex-end; }
        .chat-bubble.bot { background-color: #f1f5f9; align-self: flex-start; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-md mx-auto bg-white shadow-lg">

        <div id="page-start-login" class="page active">
            <header class="bg-gray-800 text-white p-4 flex items-center">
                <h1 class="text-xl font-bold w-full text-center">Anokha Classes Portal</h1>
            </header>
            <main class="p-6 flex-grow flex flex-col justify-center gap-4">
                <button onclick="app.showPage('page-student-login')" class="w-full bg-teal-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-teal-600">Student Login</button>
                <button onclick="app.showPage('page-teacher-login')" class="w-full bg-indigo-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-indigo-600">Teacher Login</button>
            </main>
        </div>

        <div id="page-student-login" class="page">
            <header class="bg-teal-600 text-white p-4 flex items-center sticky top-0">
                <button onclick="app.showPage('page-start-login')" class="mr-4 text-xl"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-xl font-bold w-full text-center">Student Portal</h1>
            </header>
            <main class="p-6 flex-grow flex flex-col justify-center">
                <input id="login-student-id" type="text" placeholder="Enter your ID" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-teal-500">
                <input id="login-student-password" type="password" placeholder="Enter your Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-teal-500">
                <button onclick="app.studentLogin()" class="w-full bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600">Login</button>
                <p id="student-login-error" class="text-red-500 mt-2 text-center"></p>
            </main>
        </div>

        <div id="page-student-home" class="page">
            <header id="student-home-header" class="bg-teal-600 text-white p-4 flex justify-between items-center sticky top-0">
                <h1 class="text-xl font-bold">Hello, Student</h1>
                <button onclick="app.logout('student')" class="text-white text-xl" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </header>
            <main class="p-4 space-y-4">
                 <div class="bg-white p-4 rounded-lg border shadow-sm">
                    <div class="flex justify-between items-center">
                        <div>
                            <p><strong>Name:</strong> <span id="student-home-name"></span></p>
                            <p><strong>ID:</strong> <span id="student-home-id"></span></p>
                        </div>
                        <div class="text-center">
                             <p class="text-2xl font-bold text-teal-600"><span id="student-home-attendance-percent"></span>%</p>
                             <p class="text-sm text-gray-600">Attendance</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Attendance History</h3>
                    <div id="student-home-attendance" class="rounded-lg border overflow-hidden max-h-48 overflow-y-auto"></div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Test Marks</h3>
                    <div id="student-home-marks" class="rounded-lg border overflow-hidden max-h-48 overflow-y-auto"></div>
                </div>
            </main>
             <footer class="p-4 border-t">
                 <button onclick="app.showPage('page-ai-bot')" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                    <i class="fas fa-robot"></i> AI Doubt Bot
                </button>
            </footer>
        </div>
        
        <div id="page-ai-bot" class="page">
            <header class="bg-purple-600 text-white p-4 flex items-center sticky top-0">
                <button onclick="app.showPage('page-student-home')" class="mr-4 text-xl"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-xl font-bold">AI Doubt Bot</h1>
            </header>
            <main id="chat-container" class="flex-grow p-4 space-y-4 overflow-y-auto flex flex-col bg-purple-50">
                </main>
             <div id="ai-loading" class="p-2 text-center" style="display: none;">
                <div class="animate-pulse font-medium text-purple-700">Sparky is thinking...</div>
            </div>
            <footer class="p-2 border-t bg-white">
                <div class="flex items-center gap-2">
                    <input type="file" id="image-upload-input" class="hidden" accept="image/*" onchange="app.handleImageUpload(event)">
                    <button onclick="document.getElementById('image-upload-input').click()" class="p-2 text-gray-600 hover:text-purple-600" title="Upload Image">
                        <i class="fas fa-camera fa-lg"></i>
                    </button>
                    <input id="ai-question" type="text" placeholder="Ask a question..." class="flex-grow p-2 border rounded-full px-4" onkeydown="if(event.key==='Enter') app.sendTextMessage()">
                    <button onclick="app.sendTextMessage()" class="p-2 text-purple-600 hover:text-purple-800" title="Send">
                        <i class="fas fa-paper-plane fa-lg"></i>
                    </button>
                </div>
            </footer>
        </div>

        <div id="page-teacher-login" class="page">
             <header class="bg-indigo-600 text-white p-4 flex items-center sticky top-0">
                <button onclick="app.showPage('page-start-login')" class="mr-4 text-xl"><i class="fas fa-arrow-left"></i></button>
                <h1 class="text-xl font-bold w-full text-center">Teacher Portal</h1>
            </header>
            <main class="p-6 flex-grow flex flex-col justify-center">
                <input id="teacher-password" type="password" placeholder="Enter Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500">
                <button onclick="app.teacherLogin()" class="w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600">Login</button>
                <p id="teacher-login-error" class="text-red-500 mt-2 text-center"></p>
            </main>
        </div>

        <div id="page-teacher-home" class="page">
            <header class="bg-indigo-600 text-white p-4 flex justify-between items-center sticky top-0">
                <h1 class="text-xl font-bold">Teacher Dashboard</h1>
                 <button onclick="app.logout('teacher')" class="text-white text-xl" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </header>
            <main class="p-4">
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border">
                    <h2 class="text-lg font-semibold mb-2 text-center">Add New Student</h2>
                    <input id="student-name" type="text" placeholder="Student Name" class="w-full p-2 border rounded-lg mb-2">
                    <input id="student-id" type="text" placeholder="Student ID" class="w-full p-2 border rounded-lg mb-2">
                    <input id="student-password" type="text" placeholder="Set Student Password" class="w-full p-2 border rounded-lg mb-2">
                    <button onclick="app.addStudent()" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Add Student</button>
                </div>
                <h2 class="text-lg font-semibold mb-2">Student List</h2>
                <div id="student-list" class="space-y-2"></div>
            </main>
        </div>

        <div id="page-student-edit" class="page">
            <header id="student-edit-header" class="bg-indigo-600 text-white p-4 flex items-center sticky top-0">
                 <button onclick="app.showPage('page-teacher-home', true)" class="mr-4 text-xl"><i class="fas fa-arrow-left"></i></button>
                 <h1 class="text-xl font-bold">Edit Student</h1>
            </header>
            <main class="p-4">
                <div class="bg-gray-50 p-4 rounded-lg mb-4 border">
                    <h3 class="font-semibold mb-2 text-gray-800">Attendance</h3>
                    <div class="flex items-center gap-2 mb-3">
                        <input id="edit-attendance-date" type="date" class="flex-grow p-2 border rounded-lg">
                    </div>
                     <div class="flex items-center gap-2">
                        <button onclick="app.addAttendance('Present')" class="w-full bg-green-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-green-600">Present</button>
                        <button onclick="app.addAttendance('Absent')" class="w-full bg-red-500 text-white font-bold py-2 px-2 rounded-lg hover:bg-red-600">Absent</button>
                    </div>
                    <div id="attendance-list" class="mt-3"></div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-semibold mb-2 text-gray-800">Daily Test Marks</h3>
                    <input id="edit-marks-subject" type="text" placeholder="Subject" class="w-full p-2 border rounded-lg mb-2">
                    <div class="flex gap-2 mb-2">
                         <input id="edit-marks-score" type="number" placeholder="Score" class="w-1/2 p-2 border rounded-lg">
                         <input id="edit-marks-max" type="number" placeholder="Out of" class="w-1/2 p-2 border rounded-lg">
                    </div>
                    <button onclick="app.addMark()" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">Add Mark</button>
                    <div id="marks-list" class="mt-3"></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const app = {
            students: [],
            loggedInStudentId: null,
            currentStudentId: null,

             // --- Gemini API Configuration ---
            API_KEY: "", // This is handled by the execution environment.
            API_URL: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`,
            SYSTEM_PROMPT: "You are Sparky, a friendly and cheerful AI study buddy for kids. Your goal is to make learning fun. Explain complex concepts in a simple, easy-to-understand, and encouraging way. Use analogies, short stories, and examples that a child can relate to. Keep your answers concise and positive.",

            init() {
                this.loadStudents();
                this.showPage('page-start-login');
            },

            showPage(pageId, forceRefresh = false) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                if (pageId === 'page-ai-bot' && document.getElementById('chat-container').children.length === 0){
                    this.addChatMessage("Hi! I'm Sparky, your AI study buddy. Ask me anything about your homework!", false);
                }
                if (pageId === 'page-teacher-home' && forceRefresh) {
                    this.renderStudentList();
                }
            },
            
            logout(userType) {
                if (userType === 'student') {
                    this.loggedInStudentId = null;
                    document.getElementById('login-student-id').value = '';
                    document.getElementById('login-student-password').value = '';
                } else if (userType === 'teacher') {
                    this.currentStudentId = null;
                    document.getElementById('teacher-password').value = '';
                }
                this.showPage('page-start-login');
            },

            loadStudents() {
                const raw = localStorage.getItem('students');
                if (raw) { this.students = JSON.parse(raw); }
            },
            saveStudents() {
                localStorage.setItem('students', JSON.stringify(this.students));
            },
            
            // --- Student Portal Logic ---
            studentLogin() {
                const id = document.getElementById('login-student-id').value.trim();
                const password = document.getElementById('login-student-password').value.trim();
                const errorEl = document.getElementById('student-login-error');
                
                const student = this.students.find(s => s.id === id);

                if (!student) { errorEl.textContent = 'Student ID not found.'; return; }
                if (student.password !== password) { errorEl.textContent = 'Incorrect password.'; return; }
                
                errorEl.textContent = '';
                this.loggedInStudentId = id;
                this.renderStudentHomePage();
                this.showPage('page-student-home');
            },
            renderStudentHomePage() {
                const student = this.students.find(s => s.id === this.loggedInStudentId);
                if (!student) return;

                document.querySelector('#student-home-header h1').textContent = `Hello, ${student.name.split(' ')[0]}`;
                document.getElementById('student-home-name').textContent = student.name;
                document.getElementById('student-home-id').textContent = student.id;
                document.getElementById('student-home-attendance-percent').textContent = this.calculateAttendancePercent(student.attendance);
                
                const attEl = document.getElementById('student-home-attendance');
                let attHtml = '<table class="w-full text-sm bg-white"><thead><tr class="bg-gray-50"><th class="table-cell font-semibold">Date</th><th class="table-cell font-semibold">Status</th></tr></thead><tbody>';
                if (student.attendance.length > 0) {
                    student.attendance.forEach(({ date, status }) => {
                        const statusClass = status === 'Present' ? 'text-green-600' : 'text-red-600';
                        attHtml += `<tr><td class="table-cell">${new Date(date).toLocaleDateString()}</td><td class="table-cell font-medium ${statusClass}">${status}</td></tr>`;
                    });
                } else {
                    attHtml += '<tr><td class="table-cell text-center text-gray-500" colspan="2">No attendance records.</td></tr>';
                }
                attEl.innerHTML = attHtml + '</tbody></table>';

                const marksEl = document.getElementById('student-home-marks');
                let marksHtml = '<table class="w-full text-sm bg-white"><thead><tr class="bg-gray-50"><th class="table-cell font-semibold">Date</th><th class="table-cell font-semibold">Subject</th><th class="table-cell font-semibold">Score</th></tr></thead><tbody>';
                if (student.marks.length > 0) {
                    student.marks.forEach(({ date, subject, score, maxMarks }) => {
                        marksHtml += `<tr><td class="table-cell">${new Date(date).toLocaleDateString()}</td><td class="table-cell">${subject}</td><td class="table-cell font-medium">${score} / ${maxMarks}</td></tr>`;
                    });
                } else {
                    marksHtml += '<tr><td class="table-cell text-center text-gray-500" colspan="3">No marks recorded.</td></tr>';
                }
                marksEl.innerHTML = marksHtml + '</tbody></table>';
            },
            
            calculateAttendancePercent(attendance) {
                if (!attendance || attendance.length === 0) return 0.0;
                const presentCount = attendance.filter(a => a.status === 'Present').length;
                return ((presentCount / attendance.length) * 100).toFixed(1);
            },
            
            // --- AI Bot Logic ---
            addChatMessage(content, fromUser) {
                const chatContainer = document.getElementById('chat-container');
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble p-3 rounded-lg ${fromUser ? 'user' : 'bot'}`;
                bubble.textContent = content;
                chatContainer.appendChild(bubble);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },

            async sendTextMessage() {
                const input = document.getElementById('ai-question');
                const text = input.value.trim();
                if (!text) return;
                
                this.addChatMessage(text, true);
                input.value = '';
                await this.callGeminiAPI(text);
            },
            
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result.split(',')[1];
                    this.addChatMessage('Tell me about this picture!', true);
                    await this.callGeminiAPI("Describe this image and explain any concepts in it simply for a child.", base64Image, file.type);
                };
                reader.readAsDataURL(file);
                event.target.value = '';
            },

            async callGeminiAPI(prompt, base64Image = null, mimeType = null) {
                document.getElementById('ai-loading').style.display = 'block';

                const parts = [{ text: prompt }];
                if (base64Image && mimeType) { parts.push({ inlineData: { mimeType, data: base64Image } }); }
                
                const payload = {
                    contents: [{ parts }],
                    systemInstruction: { parts: [{ text: this.SYSTEM_PROMPT }] }
                };

                try {
                    const response = await fetch(`${this.API_URL}?key=${this.API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I had a little trouble thinking. Could you ask again?";
                    this.addChatMessage(text, false);

                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    this.addChatMessage("Oops! My circuits are a bit tangled. Please try again.", false);
                } finally {
                    document.getElementById('ai-loading').style.display = 'none';
                }
            },
            
            // --- Teacher Portal Logic ---
            teacherLogin() {
                const password = document.getElementById('teacher-password').value;
                if (password === 'Anokha123') {
                    document.getElementById('teacher-login-error').textContent = '';
                    this.renderStudentList();
                    this.showPage('page-teacher-home');
                } else {
                    document.getElementById('teacher-login-error').textContent = 'Wrong password';
                }
            },
            addStudent() {
                const nameIn = document.getElementById('student-name');
                const idIn = document.getElementById('student-id');
                const passIn = document.getElementById('student-password');
                const name = nameIn.value.trim(), id = idIn.value.trim(), password = passIn.value.trim();

                if (!name || !id || !password) { alert('Name, ID, and Password are required.'); return; }
                if (this.students.some(s => s.id === id)) { alert('Student ID already exists.'); return; }

                this.students.push({ name, id, password, marks: [], attendance: [] });
                this.saveStudents();
                this.renderStudentList();
                nameIn.value = ''; idIn.value = ''; passIn.value = '';
            },
            renderStudentList() {
                const listEl = document.getElementById('student-list');
                listEl.innerHTML = this.students.length === 0 ? `<p class="text-gray-500 text-center">No students added yet.</p>` : '';
                this.students.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-3 rounded-lg border shadow-sm flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <p class="font-bold">${s.name}</p>
                            <p class="text-sm text-gray-600">ID: ${s.id}</p>
                        </div>
                        <button onclick="app.editStudent('${s.id}')" class="text-indigo-500 hover:text-indigo-700 text-xl"><i class="fas fa-edit"></i></button>
                    `;
                    listEl.appendChild(card);
                });
            },
            
            editStudent(studentId) {
                this.currentStudentId = studentId;
                const student = this.students.find(s => s.id === studentId);
                if (!student) return;

                document.querySelector('#student-edit-header h1').textContent = `Edit ${student.name}`;
                document.getElementById('edit-attendance-date').value = new Date().toISOString().slice(0, 10);
                this.renderEditAttendance(student);
                this.renderEditMarks(student);
                this.showPage('page-student-edit');
            },

            addAttendance(status) {
                const student = this.students.find(s => s.id === this.currentStudentId);
                const date = document.getElementById('edit-attendance-date').value;
                if (!date) { alert('Please select a date.'); return; }
                
                // Prevent duplicate entry for the same date
                const existingIndex = student.attendance.findIndex(att => att.date === date);
                if (existingIndex > -1) {
                   student.attendance.splice(existingIndex, 1);
                }

                student.attendance.push({ date, status });
                student.attendance.sort((a, b) => b.date.localeCompare(a.date));
                this.saveStudents();
                this.renderEditAttendance(student);
            },
            deleteAttendance(date) {
                const student = this.students.find(s => s.id === this.currentStudentId);
                student.attendance = student.attendance.filter(att => att.date !== date);
                this.saveStudents();
                this.renderEditAttendance(student);
            },
            renderEditAttendance(student) {
                const listEl = document.getElementById('attendance-list');
                let html = '<table class="w-full text-sm"><tbody>';
                if (student.attendance.length > 0) {
                    student.attendance.forEach(({ date, status }) => {
                        const statusClass = status === 'Present' ? 'text-green-600' : 'text-red-600';
                        html += `
                            <tr class="hover:bg-gray-100">
                                <td class="table-cell">${new Date(date).toLocaleDateString()}</td>
                                <td class="table-cell font-medium ${statusClass}">${status}</td>
                                <td class="table-cell text-right"><button onclick="app.deleteAttendance('${date}')" class="text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                } else {
                    html += `<tr><td class="table-cell text-center text-gray-500" colspan="3">No attendance records yet.</td></tr>`;
                }
                listEl.innerHTML = html + '</tbody></table>';
            },

            addMark() {
                const student = this.students.find(s => s.id === this.currentStudentId);
                const subjectIn = document.getElementById('edit-marks-subject');
                const scoreIn = document.getElementById('edit-marks-score');
                const maxIn = document.getElementById('edit-marks-max');

                const mark = {
                    id: Date.now(),
                    date: new Date().toISOString().slice(0, 10),
                    subject: subjectIn.value.trim(),
                    score: parseInt(scoreIn.value),
                    maxMarks: parseInt(maxIn.value)
                };

                if (!mark.subject || isNaN(mark.score) || isNaN(mark.maxMarks)) {
                    alert('Please fill all mark fields correctly.'); return;
                }

                student.marks.push(mark);
                student.marks.sort((a, b) => b.date.localeCompare(a.date));
                this.saveStudents();
                this.renderEditMarks(student);
                subjectIn.value = ''; scoreIn.value = ''; maxIn.value = '';
            },
            deleteMark(markId) {
                const student = this.students.find(s => s.id === this.currentStudentId);
                student.marks = student.marks.filter(m => m.id !== markId);
                this.saveStudents();
                this.renderEditMarks(student);
            },
            renderEditMarks(student) {
                 const listEl = document.getElementById('marks-list');
                let html = '<table class="w-full text-sm"><tbody>';
                 if (student.marks.length > 0) {
                    student.marks.forEach(({ id, date, subject, score, maxMarks }) => {
                        html += `
                            <tr class="hover:bg-gray-100">
                                <td class="table-cell">${new Date(date).toLocaleDateString()}</td>
                                <td class="table-cell">${subject}</td>
                                <td class="table-cell font-medium">${score} / ${maxMarks}</td>
                                <td class="table-cell text-right"><button onclick="app.deleteMark(${id})" class="text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                            </tr>
                        `;
                    });
                } else {
                    html += `<tr><td class="table-cell text-center text-gray-500" colspan="4">No marks entered yet.</td></tr>`;
                }
                listEl.innerHTML = html + '</tbody></table>';
            },
        };
        
        window.onload = () => app.init();
    </script>
</body>
</html